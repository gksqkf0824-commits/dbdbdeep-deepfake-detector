name: DEV CI/CD (Docker -> EC2)

on:
  push:
    branches: ["dev"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE: ghcr.io/gksqkf0824-commits/dbdbdeep-deepfake-detector-backend
  FRONTEND_IMAGE: ghcr.io/gksqkf0824-commits/dbdbdeep-deepfake-detector-frontend
  BACKEND_CACHE_IMAGE: ghcr.io/gksqkf0824-commits/dbdbdeep-deepfake-detector-backend:buildcache-dev
  FRONTEND_CACHE_IMAGE: ghcr.io/gksqkf0824-commits/dbdbdeep-deepfake-detector-frontend:buildcache-dev

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.backend }}
      frontend: ${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - "backend/**"
              - ".github/workflows/dev-ci-cd.yml"
            frontend:
              - "frontend/**"
              - ".github/workflows/dev-ci-cd.yml"
      - name: Show change detection
        run: |
          echo "event=${{ github.event_name }}"
          echo "backend=${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.backend }}"
          echo "frontend=${{ github.event_name == 'workflow_dispatch' && 'true' || steps.filter.outputs.frontend }}"

  ci:
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Backend compile check
        if: ${{ needs.changes.outputs.backend == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: compileall (backend only)
        if: ${{ needs.changes.outputs.backend == 'true' }}
        working-directory: backend
        run: python -m compileall -q .

  build_and_push:
    needs: [changes, ci]
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend (dev)
        if: ${{ needs.changes.outputs.backend == 'true' }}
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: ./backend
          push: true
          provenance: false
          sbom: false
          cache-from: |
            type=gha,scope=backend-dev
            type=registry,ref=${{ env.BACKEND_CACHE_IMAGE }}
            type=registry,ref=${{ env.BACKEND_IMAGE }}:dev-latest
          cache-to: |
            type=gha,mode=max,scope=backend-dev
            type=registry,ref=${{ env.BACKEND_CACHE_IMAGE }},mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            URL_FETCH_TOOLS_REFRESH=${{ github.run_id }}
          tags: |
            ${{ env.BACKEND_IMAGE }}:dev-latest
            ${{ env.BACKEND_IMAGE }}:dev-${{ github.sha }}

      - name: Build & push frontend (dev)
        if: ${{ needs.changes.outputs.frontend == 'true' }}
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: ./frontend
          push: true
          provenance: false
          sbom: false
          cache-from: |
            type=gha,scope=frontend-dev
            type=registry,ref=${{ env.FRONTEND_CACHE_IMAGE }}
            type=registry,ref=${{ env.FRONTEND_IMAGE }}:dev-latest
          cache-to: |
            type=gha,mode=max,scope=frontend-dev
            type=registry,ref=${{ env.FRONTEND_CACHE_IMAGE }},mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          tags: |
            ${{ env.FRONTEND_IMAGE }}:dev-latest
            ${{ env.FRONTEND_IMAGE }}:dev-${{ github.sha }}

  deploy_to_ec2:
    needs: build_and_push
    if: ${{ needs.build_and_push.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 (dev compose)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /opt/dbdbdeep-dev
            docker compose -f docker-compose.dev.yml pull
            docker compose -f docker-compose.dev.yml up -d --remove-orphans
            docker compose -f docker-compose.dev.yml images
            docker image prune -f
            docker ps | egrep "dbdbdeep-(frontend|backend|redis)-dev" || true
